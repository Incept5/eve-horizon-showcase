# Eve Horizon

> A job-first platform where AI agents are first-class citizens.
> Agents authenticate, create work, deploy code, coordinate teams, and respond to chat — all through a single CLI.

## Core Principle

Anything a human can do through the CLI, an agent can do too. Same commands. Same auth. Same API. No separate "agent API" — agents are users.

## Architecture

User/Agent -> CLI -> API Gateway -> Orchestrator -> Worker -> Runner Pod -> Agent Harness
API stores state in Postgres. Event Spine routes triggers. Chat Gateway normalizes Slack + Nostr messages.

## Quick Start

```bash
npm install -g @eve-horizon/cli
eve skills install https://github.com/incept5/eve-skillpacks
skill read eve-bootstrap
```

The bootstrap skill checks auth status and handles both new and existing users:
- Already authenticated → skips to project setup
- Not authenticated → creates profile, submits access request, waits for admin approval, auto-logs in
Admin approves with: eve admin access-requests approve <id>

## Manifest (.eve/manifest.yaml)

The manifest is the single source of truth. Schema: eve/compose/v1.
Top-level fields: schema, project, registry, services, environments, pipelines, workflows, x-eve.

### Services (Compose-Style)
Fields: image, build (context, dockerfile), environment, ports, depends_on, healthcheck, volumes.
Eve extensions (x-eve): ingress, role (component|worker|job|managed_db), api_spec, external, worker_type.

### Environments
Link to pipelines via pipeline: key. Support overrides and approval gates.
Deploy triggers pipeline: eve env deploy staging --ref main. Use --direct to bypass.

### Pipelines
Ordered steps: action (build/release/deploy/run/job/create-pr), script, or agent.
Triggers: github (push/PR with branch wildcards), cron, manual.

### Workflows
On-demand jobs with JSON input/output. Defined under workflows: key.

## Example Manifest

```yaml
schema: eve/compose/v1
project: my-app

registry:
  host: ghcr.io
  namespace: myorg
  auth:
    username_secret: GHCR_USERNAME
    token_secret: GHCR_TOKEN

services:
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    image: ghcr.io/myorg/my-api
    ports: [3000]
    environment:
      NODE_ENV: production
      DATABASE_URL: ${secret.DB_PASSWORD}
    x-eve:
      ingress:
        public: true
        port: 3000
      api_spec:
        type: openapi
        spec_url: /openapi.json

environments:
  staging:
    pipeline: deploy
    pipeline_inputs:
      smoke_test: true

pipelines:
  deploy:
    steps:
      - name: build
        action: { type: build }
      - name: release
        depends_on: [build]
        action: { type: release }
      - name: deploy
        depends_on: [release]
        action: { type: deploy }

x-eve:
  defaults:
    env: staging
    harness: mclaude
    harness_profile: primary-orchestrator
    git:
      ref_policy: auto
      branch: job/${job_id}
      create_branch: if_missing
      commit: manual
      push: never
  requires:
    secrets: [GITHUB_TOKEN, DB_PASSWORD]
  agents:
    version: 1
    availability:
      drop_unavailable: true
    profiles:
      primary-orchestrator:
        - harness: mclaude
          model: opus-4.5
          reasoning_effort: high
        - harness: codex
          model: gpt-5.2-codex
          reasoning_effort: x-high
  install_agents: [claude-code, codex, gemini-cli]
  packs:
    - source: ./skillpacks/my-pack
    - source: incept5/eve-skillpacks
      ref: 0123456789abcdef0123456789abcdef01234567
```

## Managed Environments

Declare environments in the manifest and each gets an isolated K8s namespace with services, DB, ingress, and secrets.
One manifest, N environments: test, staging, production, or any custom name.

### Key Features
- Isolated namespaces: each environment gets its own pods, networking, and storage
- Per-environment overrides: customize config, resource classes, and DB tiers
- Managed infrastructure: each env can have its own managed Postgres, auto-provisioned
- Automatic ingress: URLs as {service}.{org}-{project}-{env}.{domain}
- Approval gates: required_approvals on sensitive environments
- Promotion: build once in test, promote same artifacts to staging/production
- Ephemeral environments: spin up for PR review, tear down when done
- Environment-scoped secrets: different credentials per environment

### Environment CLI
```
eve env create staging --type persistent       Create environment
eve env deploy staging --ref main --repo-dir . Deploy to environment
eve env show <proj> <env>                      View environment status
eve env diagnose <proj> <env>                  Health check + pod status
eve env services <proj> <env>                  Per-service pod summary
eve env logs <proj> <env> <service>            Stream service logs
eve env destroy <proj> <env> --force           Tear down environment
```

### Manifest Example
```yaml
environments:
  test:
    pipeline: deploy
  staging:
    pipeline: deploy
    overrides:
      services:
        api:
          environment:
            LOG_LEVEL: debug
  production:
    pipeline: deploy-prod
    required_approvals: 1
    overrides:
      services:
        db:
          x-eve:
            managed:
              class: db.p2
```

## Secret Interpolation

${secret.KEY} in environment values. Scopes: project -> user -> org -> system (highest wins).
Runtime vars: ${ENV_NAME}, ${PROJECT_ID}, ${ORG_ID}, ${ORG_SLUG}, ${COMPONENT_NAME}.

## x-eve Extensions

### Defaults (x-eve.defaults)
env, harness, harness_profile, harness_options, hints, git, workspace, resource_class, max_cost, max_tokens.

### Agent Profiles (x-eve.agents)
Named harness+model combos with fallback ordering. version: 1, availability, profiles.
Harnesses: mclaude/claude (Anthropic), zai (Z.ai), gemini (Google), codex/code (OpenAI).

### AgentPacks (x-eve.packs)
Bundle agent config, teams, chat routing, and skills. Local or remote sources.
x-eve.install_agents: [claude-code, codex, gemini-cli]. Lock: .eve/packs.lock.yaml.

### Git Controls (x-eve.defaults.git)
ref_policy: auto|env|project_default|explicit.
branch: job/${job_id}, create_branch: if_missing, commit: manual, push: never.

## IDs

Org: org_xxx, Project: proj_xxx, Job root: {slug}-{hash8}, Job child: {parent}.{n}.
Pipeline run: prun_xxx, Build: bld_xxx, Build run: brun_xxx.

## Job Lifecycle

Phases: idea -> backlog -> ready -> active -> review -> done (or cancelled).
Priority: 0-4 (P0 highest). Dependencies via waits_for/blocks.
Git controls per job: ref, branch, commit, push policies.
Harness per job: --harness mclaude --model opus-4.5 --reasoning high, or --profile name.

## Agent Harnesses

mclaude/claude (Anthropic), zai (Z.ai), gemini (Google), codex/code (OpenAI).
Credential priority: API keys > OAuth tokens. Sandbox per workspace.
Profiles: named fallback chains defined in x-eve.agents.profiles.

## Build System

BuildSpec -> BuildRun -> Artifacts (image digests). Backends: BuildKit, Buildx, Kaniko.
Registry auth via GHCR_USERNAME + GHCR_TOKEN secrets, or use Eve-native registry (registry: eve).
OCI labels auto-injected for GHCR repo linking.

## Eve-Native Container Registry

Opt-in with registry: eve. OCI-compliant distribution backed by S3/GCS/MinIO.
Token auth: 5-min push JWTs, 1-hour pull JWTs. Auto ImagePullSecrets.
Namespace: registry.{domain}/{org_slug}/{project_slug}/{service}:{tag}.
Commands: eve registry list, eve registry tags <service>, eve registry gc, eve registry stats.

## Managed Postgres

Declare x-eve.role: managed_db on a service. Eve provisions per-environment databases.
Modes: container (app-defined), external (user URL), managed (Eve-provisioned).
Credential injection: ${managed.db.url}. Resource classes: db.p1, db.p2.
Commands: eve db status, eve db rotate-credentials, eve db scale, eve db destroy.

## Resource Management & Cost Tracking

Execution receipts: JSONB on each attempt with timing, LLM usage, compute, dual costs.
BYOK models tracked but not billed; managed models billed. Resource classes: job.c1, job.c2.
Budget enforcement: pre-admission (orchestrator), real-time (worker), environment suspension.
Balance ledger: immutable transactions with idempotency keys. FX snapshots for multi-currency.
Commands: eve job receipt, eve project spend, eve org spend, eve job compare, eve admin balance credit.

## Managed Models

Multi-scope registry: platform -> org -> project (project wins). Each model declares its harness.
Naming: managed/model-name prefix. Default catalog: DeepSeek R1, Llama 3.3, Kimi K2.5.
Self-service: org/project admins register models via API. BYOK (unprefixed) coexists with managed.
Commands: eve models list --managed, eve job create --model managed/deepseek-r1.

## Event Spine

Sources: github, slack, cron, manual, app, system, runner.
Runner events: started -> progress -> completed/failed.
Trigger routing: orchestrator matches events to manifest triggers every 5s.

## Chat Gateway

Slack (webhook) + Nostr (relay subscription). Agent slug routing.
@eve <agent-slug> <message>. Thread continuity across messages.
Discovery policy: none (hidden), discoverable (listed), routable (invokable).
Policy layers: pack default -> agent override -> project overlay; safe default is opt-in.
Client restrictions: gateway.clients limits exposure per channel (for example slack-only).
Passive listeners. Teams/pipelines unaffected by gateway visibility.
Commands: eve agents list, @eve agents list, @eve <slug> <message>, eve agents sync.

## Identity Providers

SSH (github_ssh): challenge-response via ssh-keygen.
Nostr: kind-22242 challenge + NIP-98 per-request auth.
Token TTL: 1-90 days. Invite-gated provisioning. Token minting for bots.

## Skills System

SKILL.md: YAML frontmatter + markdown instructions + references/, scripts/, assets/.
Install: skills.txt -> .eve/hooks/on-clone.sh -> .agent/skills/ -> .claude/skills/.
Progressive disclosure: metadata always, body on invoke.

## Observability

Job: follow (stream), diagnose (timeline+recommendations), attempts (timing), result.
System: health, status, logs (api/orchestrator/worker), pods, events.
Environment: diagnose (pod phase, restarts, readiness, k8s events), logs, services.
Build: diagnose (spec+runs+artifacts+logs). Pipeline: per-step timing.
Runner events: started -> progress (message/percentage) -> completed (result) / failed (error/exitCode).

## CLI Quick Reference

```
eve profile create <name> --api-url <url>      Profile management
eve auth login --email <email>                  SSH challenge login
eve auth creds                                  Check local AI credentials
eve auth sync                                   Sync OAuth tokens to Eve
eve org ensure <name> --slug <slug>             Create/ensure org
eve project ensure --name <n> --slug <s> --repo-url <url>   Create project
eve project sync                                Sync manifest
eve env create <name> --type persistent         Create environment
eve env deploy <env> --ref <sha> --repo-dir .   Deploy
eve env diagnose <proj> <env>                   Environment health
eve env logs <proj> <env> <service>             Service logs
eve job create --description "..."              Create work
eve job follow <id>                             Stream logs
eve job diagnose <id>                           Diagnostics
eve job result <id>                             Get result
eve job receipt <id> --json                     Execution receipt
eve build diagnose <id>                         Build diagnostics
eve pipeline run <name> --ref <sha>             Run pipeline
eve workflow run <proj> <name> --input '{}'     Run workflow
eve secrets set KEY value --project <id>        Store secret
eve secrets import --file .env --project <id>   Bulk import
eve event emit --type <type> --source <src>     Emit event
eve auth request-access --ssh-key <pub> --org <name> --wait  Self-service onboard
eve admin access-requests                       List pending access requests
eve admin access-requests approve <id>          Approve + provision
eve system health                               Platform health
eve system status                               System overview
eve agents sync --project <id>                  Sync agent config
eve agents list                                 Gateway-visible agents
eve packs status                                Pack status
eve db status --env <env>                       Managed DB health
eve db rotate-credentials --env <env>           Rotate DB creds
eve db scale --env <env> --class <class>        Scale DB tier
eve registry list                               List image repos
eve registry tags <service>                     List image tags
eve registry stats                              Registry storage usage
eve models list --managed                       Managed model catalog
eve project spend <id> --since 7d               Project spend
eve org spend <id> --since 30d                  Org-wide spend
eve admin balance credit --org <id> --amount N  Credit balance
```

## Links

- Showcase: https://web.incept5-evshow-staging.eh1.incept5.dev
- GitHub: https://github.com/incept5/eve-horizon-showcase
- Incept5: https://github.com/incept5
